# Sprint — 2026-02-21 (Session 3: N4, N7, N8, N9)

## Objective
Ship N4 (onboarding tooltip), N7 (board flip encodes AM/PM), N8 (game info layout), and N9 (right-click menu + floating window) — completing all remaining Phase N tasks for v0.2.0.

## Task → Agent Assignment

| Task ID | Agent | Files Owned | Status | Commit |
|---------|-------|-------------|--------|--------|
| N4 | A (foreground, phase 1) | OnboardingService.swift (new), ClockView.swift, OnboardingTests.swift (new) | pending | — |
| N7 | A (foreground, phase 2) | ClockState.swift, ClockService.swift, BoardView.swift, ClockView.swift, ClockServiceTests.swift, AMPMView.swift (delete) | pending | — |
| N8 | B (background) | scripts/build_json.py, ChessGame.swift, GameInfoView.swift, GameLibraryTests.swift, games.json (regenerated) | pending | — |
| N9 | C (background) | ChessClockApp.swift, FloatingWindowManager.swift (new) | pending | — |

## Dependency Graph

```
N4 (Agent A phase 1) ──► N7 (Agent A phase 2) ──► (senior) integration build
N8 (Agent B) ─────────────────────────────────────────────────────────────────┐
N9 (Agent C) ─────────────────────────────────────────────────────────────────┴──► integration
```

N4 and N7 are sequential within Agent A because they both modify ClockView.swift.
N8 and N9 are fully independent of A and of each other.

## Interface Contracts

### OnboardingService (N4 — Agent A):
```swift
// ChessClock/ChessClock/Services/OnboardingService.swift
struct OnboardingService {
    private static let key = "onboardingDismissed"

    static var shouldShowOnboarding: Bool {
        return !UserDefaults.standard.bool(forKey: key)
    }

    static func dismissOnboarding() {
        UserDefaults.standard.set(true, forKey: key)
    }
}
```

### ClockState after N7 (isFlipped field):
```swift
// ClockState.swift gets a new field:
struct ClockState {
    let hour: Int      // 1–12
    let minute: Int    // 0–59
    let isAM: Bool
    let isFlipped: Bool   // NEW — true when PM (= !isAM); board shown from Black's perspective
    let game: ChessGame
    let fen: String
}
// ClockService.makeState sets: isFlipped: !isAM
```

### BoardView after N7 (isFlipped param):
```swift
struct BoardView: View {
    let fen: String
    var isFlipped: Bool = false   // NEW — when true, reverses rank order
    // When isFlipped: ForEach(0..<8) uses (7 - rankIndex) to reverse rank display
}
```

### ChessGame after N8 (month/round fields):
```swift
struct ChessGame: Codable {
    let white: String
    let black: String
    let whiteElo: String
    let blackElo: String
    let tournament: String
    let year: Int
    let month: String?   // NEW — "January"–"December", nil if absent
    let round: String?   // NEW — "3", "?", etc., nil if absent or "?"
    let positions: [String]

    // Custom Codable decode: use decodeIfPresent for month and round
    // Explicit memberwise init with month: String? = nil, round: String? = nil defaults
    // (allows existing test code to create ChessGame without month/round params)
}
```

### FloatingWindowManager (N9 — Agent C):
```swift
// ChessClock/ChessClock/Services/FloatingWindowManager.swift
import AppKit
import SwiftUI

@MainActor
final class FloatingWindowManager {
    static let shared = FloatingWindowManager()
    private var panel: NSPanel?
    private let clockService = ClockService()

    func showFloatingWindow() {
        // Bring existing panel forward if visible; else create new NSPanel
        // NSPanel(styleMask: [.titled, .closable, .resizable, .nonactivatingPanel])
        // level = .floating
        // contentView = NSHostingView(rootView: ClockView(clockService: clockService))
    }
}
```

### ChessClockApp after N9 (secondary MenuBarExtra):
```swift
@main
struct ChessClockApp: App {
    @StateObject private var clockService = ClockService()
    private let hotkeyService = HotkeyService()

    var body: some Scene {
        // Primary: window-style clock
        MenuBarExtra { ClockView(clockService: clockService).onAppear { hotkeyService.register() } }
            label: { Image(systemName: "crown.fill") }
            .menuBarExtraStyle(.window)

        // Secondary: menu-style for context actions
        MenuBarExtra("Chess Clock") {
            Button("Open as Floating Window") { FloatingWindowManager.shared.showFloatingWindow() }
            Divider()
            Button("Quit Chess Clock") { NSApplication.shared.terminate(nil) }
        }
    }
}
```

## Agent Log
[Append entries here as agents start, finish, fail, or get killed]

## Issues & Adaptations
[Document every deviation from the plan here]

## Integration Checklist
[ ] N4 committed — onboarding overlay shows on first launch; 3 OnboardingTests pass
[ ] N7 committed — AMPMView removed; board flips in PM; T5 tests updated and pass
[ ] N8 committed — games.json regenerated with month/round; GameInfoView redesigned; T6 tests pass
[ ] N9 committed — second MenuBarExtra shows right-click menu; floating NSPanel works
[ ] Full build succeeded: xcodebuild build → BUILD SUCCEEDED
[ ] Full test suite: xcodebuild test → 0 failures, ≥ 36 tests (33 + 3 N4 XCTest cases)
[ ] All task IDs marked done in TODO.md
[ ] PROGRESS.md updated
[ ] Sprint file archived
